#!/usr/bin/env node

'use strict';

const path = require('path');
const fs = require('fs');
const he = require('he');

const extractTagContents = tag => tag.match(/>(.+)</)[1];

const fileContents = fs.readFileSync(path.resolve(process.cwd(), process.argv[2]), 'utf8');

const bookTitle = he.decode(extractTagContents(fileContents.match(/<h3.*<\/h3>/)[0]));
const highlights = fileContents
  .match(/<span id="highlight".*<\/span>/g)
  .map(extractTagContents)
  .map(a => he.decode(a));
const locations = fileContents
  .match(/<span id="annotationHighlightHeader".*<\/span>/g)
  .map(extractTagContents)
  .map(a => a.match(/[0-9,]+$/)[0].replace(',', ''));

if (highlights.length !== locations.length) {
  throw new Error(`Highlights and locations are not the same amount.`);
}

const stdout = JSON.stringify({
  bookTitle,
  highlights: highlights.map((text, i) => ({
    text,
    location: locations[i],
  })),
});

console.log(stdout);
