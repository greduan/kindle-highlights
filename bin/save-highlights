#!/usr/bin/env node

'use strict';

const getStdin = require('get-stdin');
const sqlite = require('sqlite');
const path = require('path');
const SQL = require('sql-template-strings');
const pSettle = require('p-settle');

const generateDatabaseRecords = highlights => {
  const inserted_at = new Date().toISOString();
  const ue_id = highlights.ueId;
  return highlights.highlights.map(highlight => ({
    ue_id,
    highlight,
    inserted_at,
  }));
};

(async () => {
  // Get a database connection.
  const db = await sqlite.open(path.resolve(process.cwd(), 'database.sqlite'), { Promise });
  // Run the database migrations.
  await db.migrate({ force: process.argv[2] === '--nuke' ? 'last' : false });

  // Get the input which is presumably passed in from the stdout of the
  // extract-highlights script.
  const input = JSON.parse(await getStdin());

  const results = await pSettle(
    generateDatabaseRecords(input)
      .map(a => db.all(
        SQL`
          INSERT
          INTO highlights
          (ue_id, highlight, inserted_at)
          VALUES (${a.ue_id}, ${a.highlight}, ${a.inserted_at})
        `)
      )
  );

  results.forEach(({ isRejected, reason }) => {
    if (
      isRejected &&
      reason.message !== 'SQLITE_CONSTRAINT: UNIQUE constraint failed: highlights.highlight'
    ) {
      console.error(reason.message);
    }
  });
})();
